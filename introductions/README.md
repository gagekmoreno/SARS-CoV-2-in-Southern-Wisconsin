# Estimating the number of introductions into Wisconsin
This repo contains code for replicating the introduction analysis in the article "Public health policies reduced SARS-CoV-2 transmission within two nearby communities in Wisconsin, USA." It relies heavily on [MAFFT](https://mafft.cbrc.jp/alignment/software/), [IQ-Tree](http://www.iqtree.org), and [TreeTime](https://github.com/neherlab/treetime) and was heavily inspired by the [NextStrain Augur](https://github.com/nextstrain/augur) pipeline. Results are visualized using [Matplotlib](https://matplotlib.org), [Seaborn](https://seaborn.pydata.org), and the wonderful [Baltic](https://github.com/evogytis/baltic). It's written in Python3 and depends on common Python dependencies such as [BioPython](https://biopython.org), [Numpy](https://numpy.org), and [Pandas](https://pandas.pydata.org). I'm still actively in the process of commenting and cleaning up the code and will be regularly updating it, although functionally it is complete. If you have any questions on these scripts feel free to contact me.

The full pipeline can be run using the bash script <code>run_all.sh</code>. Alternatively, you can run each step independent through their associated Python scripts. 

 - <code>infer_tree.py</code>
    - This file takes as input: a global alignment of all SARS-CoV-2 sequences which pass your quality filtering, a subsampled alignment (in our analysis we used all sequences from Wisconsin, 20 sequences from each other US state, and 30 sequences from each country, per month per year), a metadat file, and a global phylogenetic tree (we used the tree generated by [Dr. Rob Lanfear](https://github.com/roblanf/sarscov2phylo). The one I used was downloaded on June 14th. The alignment was generated using the [Augur](https://github.com/nextstrain/augur) pipeline.
    - First, this script identifies the closest phylogenetic neighbors of each Wisconsin sequence (after pruning sequences not in our global alignment from the tree). It then adds those sequences to the subsampled alignment. 
    - Next, we infer a tree using [IQ-Tree] (http://www.iqtree.org). We also generated 1000 [Ultrafast bootstrap trees] (https://academic.oup.com/mbe/article/35/2/518/4565479). Unfortunately per GISAID rules we cannot provide the actual alignment used in the analysis here. However, a list of incuded sequences is included (include.txt).
- <code>infer_clock_mugration.py</code>:
    - This file takes as input: The alignment and tree from the previous step, the metadata file, and a list indicating which sequences are from Dane or Milwaukee County.
    - First, this script uses TreeTime to create a time aligned tree using the tip dates. It roots the tree at Wuhan/Hu-1/2019 and assumes a mean [SD] clock rate of 0.0008 [0.0004] subs/site/yr (consistent with the ncov [Nextstrain] (https://github.com/nextstrain/ncov) build). 
    - Next, it reconstructs the discrete states of ancestral nodes based on the sampling locations of the tips. We use Dane and Milwaukee County for those tips, U.S. state for the remaining tips from U.S. states, and country for the rest of the samples. It outputs TreeTime refined trees, both with branch lengths in unit of mutations and years, and CSV files with the timing and state of internal nodes. 
- <code>estimate_importations.py</code>:
    - The basis of this script is very similar to the one above, however, it is designed to take a multi-tree file as input and conduct time aligning and ancestral state reconstruction of one of the trees (designated by the <code>--bootstrap_replicate</code> flag). 
    - Following time alignment and ancestral state reconstruction, this script goes one step further and estimates the number of introduction into Wisconsin for a given tree. It does this by finding the path from root to tip for each Wisconsin sequence (which may be designated as Dane County, Milwaukee County, or other Wisconsin) and finding the earliest node in the tree belonging to any of the Wisconsin regions (as we do not know which county the other Wisconsin sequences were from). The time of introduction is assumed to occur at the time between the earliest Wisconsin node and the latest foreign node in the path. Thus, the number of unique foreign nodes giving rise to a Wisconsin node is the number of introducitons into Wisconsin. Multifurcating foreign nodes giving rise to multiple Wisconsin nodes are attributed to a single introduction event and the timing of said introduction is set to the midbranch time between the foreign node and the earliest Wisconsin node. 
- <code>rarefaction.py</code>:
    - This script is designed to test the sensitivity of our results to biased sampling. It takes the ML tree, alignment, and metadata as input as well as a given number of sequences for which to sample. In the paper, N=20, 40, 60, 80, 100, 120, 140, 160, 180, 200, 220, and 240 was used. For each, we randomly sample N sequences from the set of Dane and Milwaukee County samples. Non-sampled sequences are pruned from the ML tree prior to ancestral state reconstruction. We then estimate the number of introductions based on this pruned tree. For each N we do 10 replicates. 
- <code>analyze_results.py</code>:
    - This script takes the results of the bootstrap and rarefaction analysis and plots them using Matplotlib, Seaborn, and Baltic. In the paper we are using a slightly edited version of the default Baltic script which allows branch colors to change at their midpoint. 

